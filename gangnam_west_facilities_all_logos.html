<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>서울시 농구장·축구장·수영장 정보 (동부)</title>
  <style>
    button {
      margin: 5px;
      padding: 8px 12px;
      border-radius: 8px;
      border: 1px solid #888;
      background-color: #f0f0f0;
      cursor: pointer;
    }
    #buttons, #results {
      margin-top: 20px;
    }
    .facility {
      margin: 10px 0;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    .type {
      display: inline-block;
      font-size: 0.9em;
      padding: 2px 6px;
      margin-right: 8px;
      border-radius: 4px;
      background-color: #d0eaff;
      color: #005b99;
    }
  </style>
</head>
<body>
  <h1>서울시 농구장·축구장·수영장 정보 (동부)</h1>
  <div id="buttons"></div>
  <div id="results"></div>

  <script>
    // 1) 먼저, 버튼을 미리 만들어 놓는다.
    const desiredAreas = ["동대문구", "중랑구", "성동구", "광진구", "강동구"];
    const buttonsDiv = document.getElementById("buttons");

    // 버튼을 화면에 고정으로 생성하고, 클릭 시 showFacilities 호출만 걸어 두기
    desiredAreas.forEach(area => {
      const btn = document.createElement("button");
      btn.textContent = area;
      // 우선 클릭 이벤트만 등록(시설 정보 없으면 '불러오는 중...' 혹은 아무것도 안 띄워짐)
      btn.onclick = () => showFacilities(area);
      buttonsDiv.appendChild(btn);
    });

    // 2) 그리고, 실제로 API에서 데이터를 불러와서 저장해 두기
    let facilities = []; // 데이터를 담아 둘 전역 배열

    // (1) CORS 문제 우회용 예시: AllOrigins CORS 프록시를 사용
    //     혹은 기업/학교 통신망 내 서버에서 프록시를 띄워도 되고,
    //     진짜 운영으로 넘어갈 때는 HTTPS 엔드포인트로 직접 요청할 수 있는 서버 쪽 코드를 별도로 두는 게 안전.
    const CORS_PROXY = "https://api.allorigins.win/raw?url=";
    const API_KEY = "7a4c614179776f7432396372726b47";
    const BASE_URL = "http://openapi.seoul.go.kr:8088/" + API_KEY + "/xml/ListPublicReservationSport/1/650/";

    const urls = [
      { type: "농구장", url: CORS_PROXY + encodeURIComponent(BASE_URL + "농구장") },
      { type: "축구장", url: CORS_PROXY + encodeURIComponent(BASE_URL + "축구장") },
      { type: "수영장", url: CORS_PROXY + encodeURIComponent(BASE_URL + "수영장") }
    ];

    // 3) Promise.all로 병렬 호출 → 에러 나도 catch에서 잡아서 console.error만 띄운다
    Promise.all(
      urls.map(entry =>
        fetch(entry.url)
          .then(res => {
            if (!res.ok) throw new Error("Fetch 실패: " + res.status);
            return res.text();
          })
          .then(str => new DOMParser().parseFromString(str, "text/xml"))
          .then(xml => {
            // XML 응답을 JS 객체로 변환
            const rows = xml.querySelectorAll("row");
            return Array.from(rows).map(row => ({
              type: entry.type,
              area: row.querySelector("AREANM")?.textContent || "",
              name: row.querySelector("SVCNM")?.textContent  || "",
              place: row.querySelector("PLACENM")?.textContent || "",
              tel: row.querySelector("TELNO")?.textContent   || "",
              status: row.querySelector("SVCSTATNM")?.textContent || "",
              url:  row.querySelector("SVCURL")?.textContent || ""
            }));
          })
      )
    )
    .then(results => {
      // (1) 결과를 1차원 배열로 합치고,
      // (2) 원하는 구(desiredAreas)에 속하는 데이터만 필터해서 전역 변수에 저장
      facilities = results
        .flat()
        .filter(f => desiredAreas.includes(f.area));
      // 이제 fetch가 성공했으므로, 버튼 클릭 시 showFacilities가 데이터를 조회해서 그리도록 준비 끝.
    })
    .catch(err => {
      console.error("데이터 로드 중 오류가 발생했습니다:", err);
      // facilities 배열은 빈 채로 남아 있고, 버튼을 눌러도 “해당 구에 정보가 없습니다”가 뜬다.
    });

    // 4) 버튼 클릭 시 실행될 함수: 전역 facilities에서 area에 맞는 목록 찾아 보여주기
    function showFacilities(area) {
      const resultsDiv = document.getElementById("results");
      resultsDiv.innerHTML = `<h2>${area} 농구장·축구장·수영장 목록</h2>`;
      // facilities가 아직 비어 있으면(아직 fetch가 안 끝났으면) '불러오는 중' 출력
      if (facilities.length === 0) {
        resultsDiv.innerHTML += "<p>시설 정보를 불러오는 중이거나, 오류로 인해 데이터가 없습니다.</p>";
        return;
      }

      const list = facilities.filter(f => f.area === area);
      if (list.length === 0) {
        resultsDiv.innerHTML += "<p>해당 구에 정보가 없습니다.</p>";
        return;
      }

      list.forEach(f => {
        const div = document.createElement("div");
        div.className = "facility";
        div.innerHTML = `
          <span class="type">${f.type}</span>
          <strong>${f.name}</strong><br>
          장소: ${f.place}<br>
          전화번호: ${f.tel || "없음"}<br>
          상태: <strong>${f.status}</strong><br>
          <a href="${f.url}" target="_blank">예약 링크</a>
        `;
        resultsDiv.appendChild(div);
      });
    }
  </script>
</body>
</html>

